name: "Workflow"

on:
  pull_request:
    types: [synchronize, opened]

jobs:
  foo:
    name: "Foo"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dir:
          - 'aaa/production'
          - 'bbb/dev'
          - 'bbb/staging'
      fail-fast: true

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Check Target Directory
        id: check_directory
        run: |
          echo ${{ matrix.dir }}
          git fetch
          git branch -a
          echo "Pull request's base branch is: ${{ github.base_ref }}"
          echo "This branch is ${GITHUB_REF#refs/heads/}"
          git diff 
          
          diffs=$(git diff remotes/origin/${{ github.base_ref }}..HEAD --diff-filter=ACDMR --name-only)
          echo $diffs
          
          found="false"
          for diff in $diffs; do
            dir=$(echo $diff | awk -F/ '{ if(NF>=2){printf("%s/%s",$1,$2)} }')
            if [ -n "$dir" ]; then
              echo $dir
              if [ "$dir" = "${{ matrix.dir }}" ]; then
                found="true"
                break
              fi
            fi
          done
          echo $found
          echo "::set-output name=is_targetdirectory::$found"

      - name: Proc1
        if: steps.check_directory.outputs.is_targetdirectory == 'true'
        run: |
          echo ${{ steps.check_directory.outputs.is_targetdirectory }}
          echo "Proc1"

      - name: Proc2
        if: steps.check_directory.outputs.is_targetdirectory == 'true'
        run: |
          echo ${{ steps.check_directory.outputs.is_targetdirectory }}
          echo "Proc2"